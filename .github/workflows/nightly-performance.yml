name: Nightly Performance Tests

on:
  schedule:
    # Run at 3 AM UTC every day (7 PM Pacific)
    - cron: '0 3 * * *'
  workflow_dispatch:

jobs:
  performance:
    name: Run Performance Tests
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Create logs directory
        run: mkdir -p logs

      - name: Run performance tests
        id: performance-test
        continue-on-error: true
        run: |
          # Run the performance test with a 30-minute timeout
          timeout 1800 pnpm test:perf || echo "::warning::Performance test timed out after 30 minutes"

          # Check for threshold violations
          if grep -q "validation > 100 ms" logs/watcher-summary.log || \
             grep -q "latency > 120 ms" logs/watcher-summary.log || \
             grep -q "RSS > 80 MB" logs/watcher-summary.log; then
            echo "::error::Performance thresholds exceeded"
            exit 1
          fi

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: performance-logs
          path: |
            logs/watcher-load-test.log
            logs/watcher-summary.log

      - name: Update performance baseline
        if: success()
        run: |
          # Update the performance baseline in the documentation
          cp logs/watcher-summary.log docs/performance/watcher-latest.log

          # Create a simple performance report
          echo "# Performance Test Results - $(date -u +'%Y-%m-%d')" > performance-report.md
          echo "## Watcher Subsystem" >> performance-report.md
          echo '```' >> performance-report.md
          cat logs/watcher-summary.log >> performance-report.md
          echo '```' >> performance-report.md

      - name: Upload performance report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: performance-report
          path: performance-report.md

      - name: Check for performance regressions
        if: steps.performance-test.outcome == 'failure'
        run: |
          echo "::error::Performance test failed. Check the logs for details."
          exit 1
